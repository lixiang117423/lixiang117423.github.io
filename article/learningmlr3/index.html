

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="小蓝哥">
  <meta name="keywords" content="">
  <meta name="google-site-verification" content="W0bd7QAXqv4_2p37UlvKzRbXgPQWZun5DbrUuQtdSI4">
  
    <meta name="description" content="mlr3verse基础mlr3verse其实是个框架，整合了各种机器学习算法。其底层的使用R6语法和data.table数据流；支持并行，可以搭建”图”流学习器。 几点技术说明：  使用帮助：?+对象名字，或者对象$help，如learner$help(). 某些对象不是数据框，as.data.table()转化成数据框再进行查看。 超参数调参需要找到原始函数对应的包的函数帮助。  任务类型 连续">
<meta property="og:type" content="article">
<meta property="og:title" content="R语言机器学习框架mlr3学习笔记">
<meta property="og:url" content="https://lixiang117423.github.io/article/learningmlr3/index.html">
<meta property="og:site_name" content="小蓝哥的知识荒原">
<meta property="og:description" content="mlr3verse基础mlr3verse其实是个框架，整合了各种机器学习算法。其底层的使用R6语法和data.table数据流；支持并行，可以搭建”图”流学习器。 几点技术说明：  使用帮助：?+对象名字，或者对象$help，如learner$help(). 某些对象不是数据框，as.data.table()转化成数据框再进行查看。 超参数调参需要找到原始函数对应的包的函数帮助。  任务类型 连续">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/000012.png">
<meta property="og:image" content="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/000002.png">
<meta property="og:image" content="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/image-20230211195950010.png">
<meta property="og:image" content="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/image-20230211200548869.png">
<meta property="article:published_time" content="2023-02-10T12:46:55.000Z">
<meta property="article:modified_time" content="2023-12-10T05:18:18.000Z">
<meta property="article:author" content="小蓝哥">
<meta property="article:tag" content="生物信息学">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/000012.png">
  
  
  
  <title>R语言机器学习框架mlr3学习笔记 - 小蓝哥的知识荒原</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lixiang117423.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小蓝哥的知识荒原" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>小蓝哥的知识荒原</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://bing.biturl.top/?resolution=1920&format=image&index=0&mkt=zh-CN') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="R语言机器学习框架mlr3学习笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-02-10 20:46" pubdate>
          2023年2月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          59 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">R语言机器学习框架mlr3学习笔记</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="mlr3verse基础"><a href="#mlr3verse基础" class="headerlink" title="mlr3verse基础"></a>mlr3verse基础</h2><p><code>mlr3verse</code>其实是个框架，整合了各种机器学习算法。其底层的使用<code>R6</code>语法和<code>data.table</code>数据流；支持并行，可以搭建”图”流学习器。</p>
<p>几点技术说明：</p>
<ul>
<li>使用帮助：?+对象名字，或者对象$help，如learner$help().</li>
<li>某些对象不是数据框，as.data.table()转化成数据框再进行查看。</li>
<li>超参数调参需要找到原始函数对应的包的函数帮助。</li>
</ul>
<h3 id="任务类型"><a href="#任务类型" class="headerlink" title="任务类型"></a>任务类型</h3><ul>
<li>连续的目标变量：回归</li>
<li>离散的目标变量：分类</li>
<li>没有目标：聚类和降维等</li>
</ul>
<p>查看自带的任务：</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs R">tsks<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">Show <span class="hljs-keyword">in</span> New Window<br><span class="hljs-operator">&lt;</span>DictionaryTask<span class="hljs-operator">&gt;</span> with <span class="hljs-number">28</span> stored values<br>Keys<span class="hljs-operator">:</span> actg<span class="hljs-punctuation">,</span> bike_sharing<span class="hljs-punctuation">,</span> boston_housing<span class="hljs-punctuation">,</span> breast_cancer<span class="hljs-punctuation">,</span> faithful<span class="hljs-punctuation">,</span> gbcs<span class="hljs-punctuation">,</span> german_credit<span class="hljs-punctuation">,</span> grace<span class="hljs-punctuation">,</span> ilpd<span class="hljs-punctuation">,</span> iris<span class="hljs-punctuation">,</span> kc_housing<span class="hljs-punctuation">,</span> lung<span class="hljs-punctuation">,</span><br>  moneyball<span class="hljs-punctuation">,</span> mtcars<span class="hljs-punctuation">,</span> optdigits<span class="hljs-punctuation">,</span> penguins<span class="hljs-punctuation">,</span> penguins_simple<span class="hljs-punctuation">,</span> pima<span class="hljs-punctuation">,</span> precip<span class="hljs-punctuation">,</span> rats<span class="hljs-punctuation">,</span> sonar<span class="hljs-punctuation">,</span> spam<span class="hljs-punctuation">,</span> titanic<span class="hljs-punctuation">,</span> unemployment<span class="hljs-punctuation">,</span> usarrests<span class="hljs-punctuation">,</span> whas<span class="hljs-punctuation">,</span><br>  wine<span class="hljs-punctuation">,</span> zoo<br></code></pre></td></tr></tbody></table></figure>
<h3 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h3><p>使用包仔带的数据并创建任务。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 提取包中的数据</span><br>dat <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"german_credit"</span><span class="hljs-punctuation">)</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br>dat<br><br><span class="hljs-comment"># 创建任务</span><br>task <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>as_task_classif<span class="hljs-punctuation">(</span>dat<span class="hljs-punctuation">,</span> target <span class="hljs-operator">=</span> <span class="hljs-string">"credit_risk"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看任务</span><br>task<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-operator">&lt;</span>TaskClassif<span class="hljs-operator">:</span>dat<span class="hljs-operator">&gt;</span> <span class="hljs-punctuation">(</span><span class="hljs-number">1000</span> x <span class="hljs-number">21</span><span class="hljs-punctuation">)</span><br><span class="hljs-operator">*</span> Target<span class="hljs-operator">:</span> credit_risk<br><span class="hljs-operator">*</span> Properties<span class="hljs-operator">:</span> twoclass<br><span class="hljs-operator">*</span> Features <span class="hljs-punctuation">(</span><span class="hljs-number">20</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span><br>  <span class="hljs-operator">-</span> fct <span class="hljs-punctuation">(</span><span class="hljs-number">14</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> credit_history<span class="hljs-punctuation">,</span> employment_duration<span class="hljs-punctuation">,</span> foreign_worker<span class="hljs-punctuation">,</span> housing<span class="hljs-punctuation">,</span> job<span class="hljs-punctuation">,</span> other_debtors<span class="hljs-punctuation">,</span> other_installment_plans<span class="hljs-punctuation">,</span><br>    people_liable<span class="hljs-punctuation">,</span> personal_status_sex<span class="hljs-punctuation">,</span> property<span class="hljs-punctuation">,</span> purpose<span class="hljs-punctuation">,</span> savings<span class="hljs-punctuation">,</span> status<span class="hljs-punctuation">,</span> telephone<br>  <span class="hljs-operator">-</span> int <span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> age<span class="hljs-punctuation">,</span> amount<span class="hljs-punctuation">,</span> duration<br>  <span class="hljs-operator">-</span> ord <span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> installment_rate<span class="hljs-punctuation">,</span> number_credits<span class="hljs-punctuation">,</span> present_residence<br></code></pre></td></tr></tbody></table></figure>
<h3 id="剔除某列"><a href="#剔除某列" class="headerlink" title="剔除某列"></a>剔除某列</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 剔除某列</span><br><br>task<span class="hljs-operator">$</span>select<span class="hljs-punctuation">(</span><br>  cols <span class="hljs-operator">=</span> dplyr<span class="hljs-operator">::</span>setdiff<span class="hljs-punctuation">(</span>task<span class="hljs-operator">$</span>feature_names<span class="hljs-punctuation">,</span> <span class="hljs-string">"telephone"</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br>task<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-operator">&lt;</span>TaskClassif<span class="hljs-operator">:</span>dat<span class="hljs-operator">&gt;</span> <span class="hljs-punctuation">(</span><span class="hljs-number">1000</span> x <span class="hljs-number">20</span><span class="hljs-punctuation">)</span><br><span class="hljs-operator">*</span> Target<span class="hljs-operator">:</span> credit_risk<br><span class="hljs-operator">*</span> Properties<span class="hljs-operator">:</span> twoclass<br><span class="hljs-operator">*</span> Features <span class="hljs-punctuation">(</span><span class="hljs-number">19</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span><br>  <span class="hljs-operator">-</span> fct <span class="hljs-punctuation">(</span><span class="hljs-number">13</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> credit_history<span class="hljs-punctuation">,</span> employment_duration<span class="hljs-punctuation">,</span> foreign_worker<span class="hljs-punctuation">,</span> housing<span class="hljs-punctuation">,</span> job<span class="hljs-punctuation">,</span> other_debtors<span class="hljs-punctuation">,</span> other_installment_plans<span class="hljs-punctuation">,</span><br>    people_liable<span class="hljs-punctuation">,</span> personal_status_sex<span class="hljs-punctuation">,</span> property<span class="hljs-punctuation">,</span> purpose<span class="hljs-punctuation">,</span> savings<span class="hljs-punctuation">,</span> status<br>  <span class="hljs-operator">-</span> int <span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> age<span class="hljs-punctuation">,</span> amount<span class="hljs-punctuation">,</span> duration<br>  <span class="hljs-operator">-</span> ord <span class="hljs-punctuation">(</span><span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> installment_rate<span class="hljs-punctuation">,</span> number_credits<span class="hljs-punctuation">,</span> present_residence<br></code></pre></td></tr></tbody></table></figure>
<h3 id="划分数据"><a href="#划分数据" class="headerlink" title="划分数据"></a>划分数据</h3><p>划分数据得到的是行号，并不是直接将数据分成两份。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R">set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><br><br>split <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>partition<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> ratio <span class="hljs-operator">=</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">,</span> stratify <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 70%作为训练集，默认分层抽样</span><br><br>split<span class="hljs-operator">$</span>train<br><br>split<span class="hljs-operator">$</span>test<br></code></pre></td></tr></tbody></table></figure>
<h1 id="学习器"><a href="#学习器" class="headerlink" title="学习器"></a>学习器</h1><p>学习器就是来自不同包里面的算法。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">mlr3<span class="hljs-operator">::</span>lrns<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-operator">&lt;</span>DictionaryLearner<span class="hljs-operator">&gt;</span> with <span class="hljs-number">53</span> stored values<br>Keys<span class="hljs-operator">:</span> classif.cv_glmnet<span class="hljs-punctuation">,</span> classif.debug<span class="hljs-punctuation">,</span> classif.featureless<span class="hljs-punctuation">,</span> classif.glmnet<span class="hljs-punctuation">,</span> classif.kknn<span class="hljs-punctuation">,</span> classif.lda<span class="hljs-punctuation">,</span> classif.log_reg<span class="hljs-punctuation">,</span><br>  classif.multinom<span class="hljs-punctuation">,</span> classif.naive_bayes<span class="hljs-punctuation">,</span> classif.nnet<span class="hljs-punctuation">,</span> classif.qda<span class="hljs-punctuation">,</span> classif.ranger<span class="hljs-punctuation">,</span> classif.rpart<span class="hljs-punctuation">,</span> classif.svm<span class="hljs-punctuation">,</span> classif.xgboost<span class="hljs-punctuation">,</span><br>  clust.agnes<span class="hljs-punctuation">,</span> clust.ap<span class="hljs-punctuation">,</span> clust.cmeans<span class="hljs-punctuation">,</span> clust.cobweb<span class="hljs-punctuation">,</span> clust.dbscan<span class="hljs-punctuation">,</span> clust.diana<span class="hljs-punctuation">,</span> clust.em<span class="hljs-punctuation">,</span> clust.fanny<span class="hljs-punctuation">,</span> clust.featureless<span class="hljs-punctuation">,</span> clust.ff<span class="hljs-punctuation">,</span><br>  clust.hclust<span class="hljs-punctuation">,</span> clust.kkmeans<span class="hljs-punctuation">,</span> clust.kmeans<span class="hljs-punctuation">,</span> clust.MBatchKMeans<span class="hljs-punctuation">,</span> clust.meanshift<span class="hljs-punctuation">,</span> clust.pam<span class="hljs-punctuation">,</span> clust.SimpleKMeans<span class="hljs-punctuation">,</span> clust.xmeans<span class="hljs-punctuation">,</span><br>  dens.hist<span class="hljs-punctuation">,</span> dens.kde<span class="hljs-punctuation">,</span> regr.cv_glmnet<span class="hljs-punctuation">,</span> regr.debug<span class="hljs-punctuation">,</span> regr.featureless<span class="hljs-punctuation">,</span> regr.glmnet<span class="hljs-punctuation">,</span> regr.kknn<span class="hljs-punctuation">,</span> regr.km<span class="hljs-punctuation">,</span> regr.lm<span class="hljs-punctuation">,</span> regr.ranger<span class="hljs-punctuation">,</span><br>  regr.rpart<span class="hljs-punctuation">,</span> regr.svm<span class="hljs-punctuation">,</span> regr.xgboost<span class="hljs-punctuation">,</span> surv.coxph<span class="hljs-punctuation">,</span> surv.cv_glmnet<span class="hljs-punctuation">,</span> surv.glmnet<span class="hljs-punctuation">,</span> surv.kaplan<span class="hljs-punctuation">,</span> surv.ranger<span class="hljs-punctuation">,</span> surv.rpart<span class="hljs-punctuation">,</span> surv.xgboost<br></code></pre></td></tr></tbody></table></figure>
<p>设定学习器的方法如下：</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs R">learner <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.ranger"</span><span class="hljs-punctuation">,</span> num.trees <span class="hljs-operator">=</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span> predict_type <span class="hljs-operator">=</span> <span class="hljs-string">"prob"</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 参数应该要超参数调参才可以的，通常。</span><br>learner<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&lt;LearnerClassifRanger:classif.ranger&gt;<br>* Model: -<br>* Parameters: num.threads=<span class="hljs-number">1</span>, num.trees=<span class="hljs-number">100</span><br>* Packages: mlr3, mlr3learners, ranger<br>* Predict <span class="hljs-keyword">Type</span>: prob<br>* Feature <span class="hljs-keyword">types</span>: logical, <span class="hljs-type">integer</span>, <span class="hljs-type">numeric</span>, <span class="hljs-type">character</span>, factor, ordered<br>* Properties: hotstart_backward, importance, multiclass, oob_error, twoclass, weights<br></code></pre></td></tr></tbody></table></figure>
<h3 id="开始训练模型"><a href="#开始训练模型" class="headerlink" title="开始训练模型"></a>开始训练模型</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs R">learner<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br><br>learner<span class="hljs-operator">$</span>model <span class="hljs-comment"># 这个模型就和普通的R包训练得到的结果是一样的</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lasso">Ranger result<br><br>Call:<br> ranger<span class="hljs-type">::ranger</span>(dependent.<span class="hljs-built_in">variable</span>.name = task$target_names, <span class="hljs-built_in">data</span> = task$data(),      probability = <span class="hljs-built_in">self</span>$predict_type == <span class="hljs-string">"prob"</span>, <span class="hljs-keyword">case</span>.weights = task$weights$weight,      num.threads = <span class="hljs-number">1</span>L, num.trees = <span class="hljs-number">100</span>L) <br><br><span class="hljs-keyword">Type</span>:                             Probability estimation <br>Number of trees:                  <span class="hljs-number">100</span> <br>Sample size:                      <span class="hljs-number">700</span> <br>Number of independent variables:  <span class="hljs-number">19</span> <br>Mtry:                             <span class="hljs-number">4</span> <br>Target node size:                 <span class="hljs-number">10</span> <br><span class="hljs-built_in">Variable</span> importance mode:         <span class="hljs-literal">none</span> <br>Splitrule:                        gini <br>OOB prediction error (Brier s.):  <span class="hljs-number">0.1615879</span> <br></code></pre></td></tr></tbody></table></figure>
<h3 id="进行预测"><a href="#进行预测" class="headerlink" title="进行预测"></a>进行预测</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs R">prediction <span class="hljs-operator">=</span> learner<span class="hljs-operator">$</span>predict<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>test<span class="hljs-punctuation">)</span><br>prediction<br></code></pre></td></tr></tbody></table></figure>
<h3 id="模型性能评估"><a href="#模型性能评估" class="headerlink" title="模型性能评估"></a>模型性能评估</h3><p>查看性能度量指标：</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">mlr3<span class="hljs-operator">::</span>msrs<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">&lt;DictionaryMeasure&gt; with <span class="hljs-number">87</span> stored values<br>Keys: aic, bic, classif<span class="hljs-selector-class">.acc</span>, classif<span class="hljs-selector-class">.auc</span>, classif<span class="hljs-selector-class">.bacc</span>, classif<span class="hljs-selector-class">.bbrier</span>, classif<span class="hljs-selector-class">.ce</span>, classif<span class="hljs-selector-class">.costs</span>, classif<span class="hljs-selector-class">.dor</span>,<br>  classif<span class="hljs-selector-class">.fbeta</span>, classif<span class="hljs-selector-class">.fdr</span>, classif<span class="hljs-selector-class">.fn</span>, classif<span class="hljs-selector-class">.fnr</span>, classif<span class="hljs-selector-class">.fomr</span>, classif<span class="hljs-selector-class">.fp</span>, classif<span class="hljs-selector-class">.fpr</span>, classif<span class="hljs-selector-class">.logloss</span>,<br>  classif<span class="hljs-selector-class">.mbrier</span>, classif<span class="hljs-selector-class">.mcc</span>, classif<span class="hljs-selector-class">.npv</span>, classif<span class="hljs-selector-class">.ppv</span>, classif<span class="hljs-selector-class">.prauc</span>, classif<span class="hljs-selector-class">.precision</span>, classif<span class="hljs-selector-class">.recall</span>,<br>  classif<span class="hljs-selector-class">.sensitivity</span>, classif<span class="hljs-selector-class">.specificity</span>, classif<span class="hljs-selector-class">.tn</span>, classif<span class="hljs-selector-class">.tnr</span>, classif<span class="hljs-selector-class">.tp</span>, classif<span class="hljs-selector-class">.tpr</span>, clust<span class="hljs-selector-class">.ch</span>, clust<span class="hljs-selector-class">.db</span>,<br>  clust<span class="hljs-selector-class">.dunn</span>, clust<span class="hljs-selector-class">.silhouette</span>, clust<span class="hljs-selector-class">.wss</span>, debug, dens<span class="hljs-selector-class">.logloss</span>, oob_error, regr<span class="hljs-selector-class">.bias</span>, regr<span class="hljs-selector-class">.ktau</span>, regr<span class="hljs-selector-class">.mae</span>, regr<span class="hljs-selector-class">.mape</span>,<br>  regr<span class="hljs-selector-class">.maxae</span>, regr<span class="hljs-selector-class">.medae</span>, regr<span class="hljs-selector-class">.medse</span>, regr<span class="hljs-selector-class">.mse</span>, regr<span class="hljs-selector-class">.msle</span>, regr<span class="hljs-selector-class">.pbias</span>, regr<span class="hljs-selector-class">.rae</span>, regr<span class="hljs-selector-class">.rmse</span>, regr<span class="hljs-selector-class">.rmsle</span>, regr<span class="hljs-selector-class">.rrse</span>,<br>  regr<span class="hljs-selector-class">.rse</span>, regr<span class="hljs-selector-class">.rsq</span>, regr<span class="hljs-selector-class">.sae</span>, regr<span class="hljs-selector-class">.smape</span>, regr<span class="hljs-selector-class">.srho</span>, regr<span class="hljs-selector-class">.sse</span>, selected_features, sim<span class="hljs-selector-class">.jaccard</span>, sim<span class="hljs-selector-class">.phi</span>, surv<span class="hljs-selector-class">.brier</span>,<br>  surv<span class="hljs-selector-class">.calib_alpha</span>, surv<span class="hljs-selector-class">.calib_beta</span>, surv<span class="hljs-selector-class">.chambless_auc</span>, surv<span class="hljs-selector-class">.cindex</span>, surv<span class="hljs-selector-class">.dcalib</span>, surv<span class="hljs-selector-class">.graf</span>, surv<span class="hljs-selector-class">.hung_auc</span>,<br>  surv<span class="hljs-selector-class">.intlogloss</span>, surv<span class="hljs-selector-class">.logloss</span>, surv<span class="hljs-selector-class">.mae</span>, surv<span class="hljs-selector-class">.mse</span>, surv<span class="hljs-selector-class">.nagelk_r2</span>, surv<span class="hljs-selector-class">.oquigley_r2</span>, surv<span class="hljs-selector-class">.rmse</span>, surv<span class="hljs-selector-class">.schmid</span>,<br>  surv<span class="hljs-selector-class">.song_auc</span>, surv<span class="hljs-selector-class">.song_tnr</span>, surv<span class="hljs-selector-class">.song_tpr</span>, surv<span class="hljs-selector-class">.uno_auc</span>, surv<span class="hljs-selector-class">.uno_tnr</span>, surv<span class="hljs-selector-class">.uno_tpr</span>, surv<span class="hljs-selector-class">.xu_r2</span>, time_both,<br>  time_predict, time_train<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 查看准确率</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 混淆矩阵</span><br><br>prediction<span class="hljs-operator">$</span>confusion<br><br><span class="hljs-comment"># 查准率</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.precision"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 召回率</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.recall"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制ROC曲线</span><br>mlr3verse<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>prediction<span class="hljs-punctuation">,</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"roc"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># AUC曲线</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.auc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/000012.png" srcset="/img/loading.gif" lazyload alt="000012"></p>
<h3 id="重抽样"><a href="#重抽样" class="headerlink" title="重抽样"></a>重抽样</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 支持的重抽样方法</span><br>mlr3<span class="hljs-operator">::</span>rsmps<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 10倍交叉验证</span><br>cv10 <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 抽样策略</span><br><br><span class="hljs-comment"># 实例化</span><br>cv10<span class="hljs-operator">$</span>instantiate<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 使用重抽样</span><br><span class="hljs-comment"># 需要提供任务、学习器和重抽样方法</span><br>rr <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>resample<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> learner<span class="hljs-punctuation">,</span> cv10<span class="hljs-punctuation">,</span> store_models <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 保存每次的模型</span><br><br><span class="hljs-comment"># 查看平均准确率</span><br>rr<span class="hljs-operator">$</span>aggregate<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看每次的准确率</span><br>rr<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>rr<span class="hljs-operator">$</span>prediction<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h3><p>基准测试指的是比较不同的算法、在多个任务或者是不同抽样策略上的平均表现。<br>测试时要保证测试的公平性，也就是喂给每个算法的数据必须是一样的，也就是重抽样得到的数据应该同时喂给每个算法。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 构建任务</span><br>tasks <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"sonar"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 选择学习器</span><br>learners <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrns<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">"classif.rpart"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment"># 决策树</span><br>                        <span class="hljs-string">"classif.kknn"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment"># KNN</span><br>                        <span class="hljs-string">"classif.ranger"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment"># 随机森林</span><br>                        <span class="hljs-string">"classif.svm"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment"># 支持向量机</span><br>                      predict_type <span class="hljs-operator">=</span> <span class="hljs-string">"prob"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 构建基准测试</span><br>design <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>benchmark_grid<span class="hljs-punctuation">(</span>tasks<span class="hljs-punctuation">,</span> learners<span class="hljs-punctuation">,</span> mlr3<span class="hljs-operator">::</span>rsmps<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>design<br><br><span class="hljs-comment"># 执行基准测试</span><br>bmr <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>benchmark<span class="hljs-punctuation">(</span>design <span class="hljs-operator">=</span> design<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看平均的结果</span><br>bmr<span class="hljs-operator">$</span>aggregate<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                   msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.auc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># ROC曲线</span><br>mlr3verse<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>bmr<span class="hljs-punctuation">,</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"roc"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># AUC图</span><br>mlr3verse<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>bmr<span class="hljs-punctuation">,</span> measure <span class="hljs-operator">=</span> msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.auc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="图学习器"><a href="#图学习器" class="headerlink" title="图学习器"></a>图学习器</h3><p>图学习器的主要用途：</p>
<ul>
<li>特征工程：缺失值插补、特征提取、特征选择、不均衡数据处理……</li>
<li>集成学习：装袋法、堆叠法</li>
<li>分支训练和分块训练</li>
</ul>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 简单的线性图</span><br>graph <span class="hljs-operator">=</span> mlr3verse<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"scale"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;&gt;%</span>  <span class="hljs-comment"># 数据归一化</span><br>  mlr3verse<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"encode"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;&gt;%</span>       <span class="hljs-comment"># 数据重编码</span><br>  mlr3verse<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputemedian"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;&gt;%</span> <span class="hljs-comment"># 中位数插补</span><br>  mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.rpart"</span><span class="hljs-punctuation">)</span>         <span class="hljs-comment"># 接上学习器</span><br><br><span class="hljs-comment"># 图可视化</span><br>graph<span class="hljs-operator">$</span>plot<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 转换为学习器</span><br>gl <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>as_learner<span class="hljs-punctuation">(</span>graph<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 训练任务</span><br>task <span class="hljs-operator">=</span> tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><br><br>gl<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 调试图</span><br><br><span class="hljs-comment"># 设置学习器超参数</span><br>graph<span class="hljs-operator">$</span>pipeops<span class="hljs-operator">$</span>scale<span class="hljs-operator">$</span>param_set<span class="hljs-operator">$</span>values<span class="hljs-operator">$</span>center <span class="hljs-operator">=</span> <span class="hljs-literal">FALSE</span><br><br><span class="hljs-comment"># 取单独的PipeOp的$state</span><br>graph<span class="hljs-operator">$</span>keep_results <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><br>graph<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><br>graph<span class="hljs-operator">$</span>pipeops<span class="hljs-operator">$</span>scale<span class="hljs-operator">$</span>state<span class="hljs-operator">$</span>scale<br><br><span class="hljs-comment"># 查看中间结果</span><br>graph<span class="hljs-operator">$</span>pipeops<span class="hljs-operator">$</span>scale<span class="hljs-operator">$</span>.result<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>head<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><h3 id="加载需要的包"><a href="#加载需要的包" class="headerlink" title="加载需要的包"></a>加载需要的包</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs R">library<span class="hljs-punctuation">(</span>tidyverse<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>mlr3verse<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>mlr3pipelines<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggthemes<span class="hljs-punctuation">)</span><br>library<span class="hljs-punctuation">(</span>ggplot2<span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="什么是特征工程"><a href="#什么是特征工程" class="headerlink" title="什么是特征工程"></a>什么是特征工程</h3><p>简单来说就是将自变量转换成能够更好的表达问题本质的新变量的过程，也就是对自变量进行处理。<br>数据清洗和特征工程属于机器学习中的数据预处理过程，使用<code>mlr3pipelines</code>这个包来实现。</p>
<h3 id="选择器函数"><a href="#选择器函数" class="headerlink" title="选择器函数"></a>选择器函数</h3><ul>
<li>selector_all(): 选择所有特征</li>
<li>selector_none():不选择任何特征</li>
<li>selector_type():根据类型选择特征</li>
<li>selector_name():根据特征名字选择特征</li>
<li>selector_grep():利用正则表达式选择特征</li>
<li>selector_invert():反选某个选择器的特征</li>
<li>selector_intersect/union/setdiff():两个选择器特征的交集、并集和差集</li>
<li>selector_missing():选择含有缺失值的特征</li>
<li>selector_cardinality_greater_than():根据分类特征个数阈值进行筛选</li>
</ul>
<h3 id="affcet-columns参数"><a href="#affcet-columns参数" class="headerlink" title="affcet_columns参数"></a>affcet_columns参数</h3><p>这个参数组要用于说明作用于哪些列。</p>
<h3 id="查看所有的PipeOp"><a href="#查看所有的PipeOp" class="headerlink" title="查看所有的PipeOp"></a>查看所有的PipeOp</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs R">mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight pf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs pf">Show <span class="hljs-keyword">in</span> New Window<br><span class="hljs-variable">&lt;DictionaryPipeOp&gt;</span> with <span class="hljs-number">74</span> stored values<br>Keys: boxcox, branch, chunk, classbalancing, classifavg, classweights, colapply, collapsefactors, colroles, compose_crank, compose_distr,<br>  compose_probregr, copy, crankcompose, datefeatures, distrcompose, encode, encodeimpact, encodelmer, featureunion, filter, fixfactors,<br>  histbin, ica, imputeconstant, imputehist, imputelearner, imputemean, imputemedian, imputemode, imputeoor, imputesample, kernelpca, learner,<br>  learner_cv, missind, modelmatrix, multiplicityexply, multiplicityimply, mutate, nmf, nop, ovrsplit, ovrunite, pca, proxy, quantilebin,<br>  randomprojection, randomresponse, regravg, removeconstants, renamecolumns, replicate, scale, scalemaxabs, scalerange, select, smote,<br>  spatialsign, subsample, survavg, targetinvert, targetmutate, targettrafoscalerange, textvectorizer, threshold, trafopred_regrsurv,<br>  trafopred_survregr, trafotask_regrsurv, trafotask_survregr, tunethreshold, unbranch, vtreat, yeojohnson<br>Show <span class="hljs-keyword">in</span> New Window<br><span class="hljs-variable">&lt;ParamSetCollection&gt;</span><br>R Console<br>Description:data.<span class="hljs-built_in">table</span> [<span class="hljs-number">18</span> × <span class="hljs-number">7</span>]<br>id<br><span class="hljs-variable">&lt;chr&gt;</span><br>class<br><span class="hljs-variable">&lt;chr&gt;</span><br>scale.center	ParamLgl	<br>scale.scale	ParamLgl	<br>scale.robust	ParamLgl	<br>scale.affect_columns	ParamUty	<br>pca.center	ParamLgl	<br>pca.scale.	ParamLgl	<br>pca.rank.	ParamInt	<br>pca.affect_columns	ParamUty	<br>classif.rpart.cp	ParamDbl	<br>classif.rpart.keep_model	ParamLgl	<br><span class="hljs-number">1</span>-<span class="hljs-number">10</span> of <span class="hljs-number">18</span> rows | <span class="hljs-number">1</span>-<span class="hljs-number">2</span> of <span class="hljs-number">7</span> columns<br>data.<span class="hljs-built_in">table</span><br><span class="hljs-number">18</span> x <span class="hljs-number">7</span><br>Description:data.<span class="hljs-built_in">table</span> [<span class="hljs-number">18</span> × <span class="hljs-number">7</span>]<br>id<br><span class="hljs-variable">&lt;chr&gt;</span><br>class<br><span class="hljs-variable">&lt;chr&gt;</span><br>lower<br><span class="hljs-variable">&lt;dbl&gt;</span><br>upper<br><span class="hljs-variable">&lt;dbl&gt;</span><br>nlevels<br><span class="hljs-variable">&lt;dbl&gt;</span><br><span class="hljs-keyword">default</span><br><span class="hljs-variable">&lt;list&gt;</span><br>value<br><span class="hljs-variable">&lt;list&gt;</span><br>scale.center	ParamLgl	NA	NA	<span class="hljs-number">2</span>	<span class="hljs-variable">&lt;lgl [1]&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>scale.scale	ParamLgl	NA	NA	<span class="hljs-number">2</span>	<span class="hljs-variable">&lt;lgl [1]&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>scale.robust	ParamLgl	NA	NA	<span class="hljs-number">2</span>	<span class="hljs-variable">&lt;S3: NoDefault&gt;</span>	<span class="hljs-variable">&lt;lgl [1]&gt;</span><br>scale.affect_columns	ParamUty	NA	NA	Inf	<span class="hljs-variable">&lt;S3: Selector&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>pca.center	ParamLgl	NA	NA	<span class="hljs-number">2</span>	<span class="hljs-variable">&lt;lgl [1]&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>pca.scale.	ParamLgl	NA	NA	<span class="hljs-number">2</span>	<span class="hljs-variable">&lt;lgl [1]&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>pca.rank.	ParamInt	<span class="hljs-number">1</span>	Inf	Inf	<span class="hljs-variable">&lt;NULL&gt;</span>	<span class="hljs-variable">&lt;int [1]&gt;</span><br>pca.affect_columns	ParamUty	NA	NA	Inf	<span class="hljs-variable">&lt;S3: Selector&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>classif.rpart.cp	ParamDbl	<span class="hljs-number">0</span>	<span class="hljs-number">1</span>	Inf	<span class="hljs-variable">&lt;dbl [1]&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br>classif.rpart.keep_model	ParamLgl	NA	NA	<span class="hljs-number">2</span>	<span class="hljs-variable">&lt;lgl [1]&gt;</span>	<span class="hljs-variable">&lt;NULL&gt;</span><br><span class="hljs-number">1</span>-<span class="hljs-number">10</span> of <span class="hljs-number">18</span> rows<br>Show <span class="hljs-keyword">in</span> New Window<br>Description:data.<span class="hljs-built_in">table</span> [<span class="hljs-number">8</span> × <span class="hljs-number">1</span>]<br>key<br><span class="hljs-variable">&lt;chr&gt;</span><br>imputeconstant				<br>imputehist				<br>imputelearner				<br>imputemean				<br>imputemedian				<br>imputemode				<br>imputeoor				<br>imputesample				<br><span class="hljs-number">8</span> rows<br>Show <span class="hljs-keyword">in</span> New Window<br>diabetes      age pedigree pregnant  glucose  insulin     mass pressure  triceps <br>       <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span>        <span class="hljs-number">0</span> <br></code></pre></td></tr></tbody></table></figure>
<h3 id="如何理解"><a href="#如何理解" class="headerlink" title="如何理解"></a>如何理解</h3><p>以“标准化”这个管道为例，其中$train()接收训练数据，对输入数据进行标准化处理，在这个过程中训练好的参数（平均值和标准差）将作为state保存下来。在predict()的时候是直接调用state中保存好的参数，而不是重新计算标准差和平均值。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs R">gr <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"scale"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;&gt;%</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"pca"</span><span class="hljs-punctuation">,</span> rank. <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 保留的主成分数量</span><br>gr<span class="hljs-operator">$</span>plot<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 调试</span><br>task <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><br><br>gr<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 训练</span><br>gr<span class="hljs-operator">$</span>predict<span class="hljs-punctuation">(</span>task<span class="hljs-operator">$</span>filter<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 原始任务经过特征工程后再用于机器学习流程</span><br>new.task <span class="hljs-operator">=</span> gr<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.task<br><br><span class="hljs-comment"># 后面可以再接一个机器学习算法</span><br>gr <span class="hljs-operator">=</span> gr <span class="hljs-operator">%&gt;&gt;%</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.rpart"</span><span class="hljs-punctuation">)</span><br>gr<span class="hljs-operator">$</span>plot<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 转换为学习器</span><br>gr_learner<span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>as_learner<span class="hljs-punctuation">(</span>gr<span class="hljs-punctuation">)</span><br>gr_learner<br><br><span class="hljs-comment"># 查看所有调参参数</span><br>gr_learner<span class="hljs-operator">$</span>param_set<br></code></pre></td></tr></tbody></table></figure>
<h3 id="缺失值插补"><a href="#缺失值插补" class="headerlink" title="缺失值插补"></a>缺失值插补</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 查看目前支持的方法</span><br><span class="hljs-comment">#as.data.table(mlr_pipeops)[tags %in% "missings", "key"]</span><br>mlr3pipelines<span class="hljs-operator">::</span>mlr_pipeops <span class="hljs-operator">%&gt;%</span> <br>  mlr3verse<span class="hljs-operator">::</span>as.data.table<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>filter<span class="hljs-punctuation">(</span>tags <span class="hljs-operator">%in%</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">"missings"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"key"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>select<span class="hljs-punctuation">(</span><span class="hljs-string">"key"</span><span class="hljs-punctuation">)</span><span class="hljs-comment"># tidyverse语法</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight ebnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">imputeconstant				</span><br><span class="hljs-attribute">imputehist				</span><br><span class="hljs-attribute">imputelearner				</span><br><span class="hljs-attribute">imputemean				</span><br><span class="hljs-attribute">imputemedian				</span><br><span class="hljs-attribute">imputemode				</span><br><span class="hljs-attribute">imputeoor				</span><br><span class="hljs-attribute">imputesample</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 简单插补</span><br>task <span class="hljs-operator">=</span> tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"pima"</span><span class="hljs-punctuation">)</span><br><br>task<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 查看缺失值</span><br><br><span class="hljs-comment"># 特定列进行插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputeconstant"</span><span class="hljs-punctuation">,</span><br>                       param_vals <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>                         constant <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-number">999</span><span class="hljs-punctuation">,</span><br>                         affect_columns <span class="hljs-operator">=</span> selector_name<span class="hljs-punctuation">(</span><span class="hljs-string">"glucose"</span><span class="hljs-punctuation">)</span><br>                       <span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>new.task <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-comment"># 这个地方的训练相当于对原始数据进行缺失值的常数插补</span><br>new.task<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 均值插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputemean"</span><span class="hljs-punctuation">)</span><br>new.tak <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 中位数插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputemedian"</span><span class="hljs-punctuation">)</span><br>new.tak <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 众数插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputemode"</span><span class="hljs-punctuation">)</span><br>new.tak <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 随机抽样插补</span><br><span class="hljs-comment"># 从非缺失的训练数据中随机抽样进行插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputesample"</span><span class="hljs-punctuation">)</span><br>new.tak <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 直方图法插补</span><br><span class="hljs-comment"># 相当于把数据进行划分，然后进行插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputehist"</span><span class="hljs-punctuation">)</span><br>new.tak <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="学习器插补"><a href="#学习器插补" class="headerlink" title="学习器插补"></a>学习器插补</h3><p>为每个特征变量拟合一个学习器来插补特征。<br>学习器支持的特征才可以被插补，也就是说回归类型的学习器只能插补整数和数值特征，分类类型的学习器可以插补因子、有序因子和逻辑特征值等。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 决策树插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputelearner"</span><span class="hljs-punctuation">,</span> lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.rpart"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>new.task <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># KNN插补</span><br><span class="hljs-comment"># 先用直方图法插补再用KNN学习器插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputelearner"</span><span class="hljs-punctuation">,</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputehist"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;&gt;%</span> lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.kknn"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>new.task <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.tak<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 超出范围插补</span><br><span class="hljs-comment"># 适用于基于树的模型</span><br><span class="hljs-comment"># 增加一个新的水平".MISSING"来插补因子特征。</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputeoor"</span><span class="hljs-punctuation">)</span><br>new.task <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br>new.task<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="特征缩放"><a href="#特征缩放" class="headerlink" title="特征缩放"></a>特征缩放</h3><p>不同特征之间的差异可能会很大，对模型的影响可能会很大，因此需要做归一化处理，也就是对特征进行缩放。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 标准化</span><br><span class="hljs-comment"># 均值为0，标准差为1,如果是正态分布的数据则最佳</span><br><br>pos <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"scale"</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># scale = FALSE表示只做中心化</span><br>pos<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 归一化</span><br><span class="hljs-comment"># 将数据放缩到[0,1]区间 </span><br><br>pop <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"scalerange"</span><span class="hljs-punctuation">,</span> param_vals <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>lower <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> upper <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>pop<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 行规范化</span><br><span class="hljs-comment"># 简单理解就是对行进行处理</span><br>pop <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"spatialsign"</span><span class="hljs-punctuation">)</span><br>pop<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="特征变换"><a href="#特征变换" class="headerlink" title="特征变换"></a>特征变换</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 计算新特征</span><br><span class="hljs-comment"># 比如可以根据病害等级计算病情指数</span><br>task <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"mutate"</span><span class="hljs-punctuation">,</span>mutation <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span><br>  x1_p <span class="hljs-operator">=</span> <span class="hljs-operator">~</span>Sepal.Length <span class="hljs-operator">+</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  area1 <span class="hljs-operator">=</span> <span class="hljs-operator">~</span>Sepal.Length <span class="hljs-operator">*</span> Sepal.Width<span class="hljs-punctuation">,</span><br>  area2 <span class="hljs-operator">=</span> <span class="hljs-operator">~</span>Petal.Length <span class="hljs-operator">*</span> Petal.Width<span class="hljs-punctuation">,</span><br>  area <span class="hljs-operator">=</span> <span class="hljs-operator">~</span>area1 <span class="hljs-operator">+</span> area2<br><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 正态性变换</span><br><span class="hljs-comment"># Box-Cox变换可以将非负的非正态数据转换成正态分布数据,算法会自动计算参数</span><br><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"boxcox"</span><span class="hljs-punctuation">)</span><br>pop<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 如果数据中包含了0和负数，则需要用Yeo-Johnson变换</span><br><span class="hljs-comment"># 使用bestNormalize可以将变换后的数据转为原始数据</span><br>pop <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"yeojohnson"</span><span class="hljs-punctuation">)</span><br>pop<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="特征降维"><a href="#特征降维" class="headerlink" title="特征降维"></a>特征降维</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># PCA</span><br><span class="hljs-comment"># 不用选择所有主成分，一般85%以上就可以</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"pca"</span><span class="hljs-punctuation">,</span> rank. <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 核PCA</span><br><span class="hljs-comment"># PCA用于线性降维，KPCA用于非线性降维，处理线性不可分的数据集</span><br><span class="hljs-comment"># 原理是将线性不可分的映射到高维空间，再进行PCA</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"kernelpca"</span><span class="hljs-punctuation">,</span> features <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># iris数据集是线性可分的，此处只是举例</span><br><br><span class="hljs-comment"># ICA独立成分分析</span><br><span class="hljs-comment"># 提取统计意义上的独立成分</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"ica"</span><span class="hljs-punctuation">,</span> n.comp <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <br><br><span class="hljs-comment"># NMF：非负矩阵分解</span><br><span class="hljs-comment"># 保证矩阵非负的同时能够减少数据量，相当于把n维的数据降到r维</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"nmf"</span><span class="hljs-punctuation">,</span> rank <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <br><br><span class="hljs-comment"># 剔除常量特征</span><br><span class="hljs-comment"># </span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"removeconstants"</span><span class="hljs-punctuation">)</span><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <br><br><span class="hljs-comment"># 因子合并</span><br><span class="hljs-comment"># 将数量少的因子合并到数量较多的因子中去</span><br><span class="hljs-comment"># 训练集中没有的因子水平在测试集中出现了也不会被使用</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"collapsefactors"</span><span class="hljs-punctuation">,</span> target_level_count <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br>po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <br><br><span class="hljs-comment"># 因子编码</span><br><span class="hljs-comment"># 独热编码：分类型的转换成二值型，如一列有三种颜色，则需要转化成三列，如是否红色，是标为1，否标为0</span><br><span class="hljs-comment"># 虚拟编码相当于独热编码删除一列</span><br>task <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"penguins"</span><span class="hljs-punctuation">)</span><br>poe <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"encode"</span><span class="hljs-punctuation">,</span> method <span class="hljs-operator">=</span> <span class="hljs-string">"one-hot"</span><span class="hljs-punctuation">)</span><br>poe<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <br></code></pre></td></tr></tbody></table></figure>
<h3 id="不均衡数据处理"><a href="#不均衡数据处理" class="headerlink" title="不均衡数据处理"></a>不均衡数据处理</h3><ul>
<li>欠采样：多数类只保留了一部分</li>
<li>过采样：少数类超量采样</li>
</ul>
<h2 id="超参数调参"><a href="#超参数调参" class="headerlink" title="超参数调参"></a>超参数调参</h2><h3 id="什么是超参数调参"><a href="#什么是超参数调参" class="headerlink" title="什么是超参数调参"></a>什么是超参数调参</h3><p>简单来说揪是让模型自动找到最佳参数。<br>使用mlr3tuning实现。</p>
<h3 id="工作内容"><a href="#工作内容" class="headerlink" title="工作内容"></a>工作内容</h3><p>搜索空间、学习器、任务、重新抽样策略、模型性能度量指标及终止条件。</p>
<h3 id="查看学习器超参数"><a href="#查看学习器超参数" class="headerlink" title="查看学习器超参数"></a>查看学习器超参数</h3><p>需要先知道学习器包含哪些参数。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs {r}">learner = mlr3::lrn("classif.svm")<br>learner$param_set$ids()<br>learner$param_set<br></code></pre></td></tr></tbody></table></figure>
<h3 id="独立参数"><a href="#独立参数" class="headerlink" title="独立参数"></a>独立参数</h3><p>tune()进行超参数调参，需要设定以下参数：</p>
<ul>
<li>method：调参方法，支持以下这些<ul>
<li>grid_search：网络搜索</li>
<li>random_search：随机搜索</li>
<li>gensa：广义模拟退火</li>
<li>nloptr：非线性优化</li>
</ul>
</li>
<li>task：任务</li>
<li>learner：带调参的学习器或普通学习器</li>
<li>resampling：重抽样策略</li>
<li>measures：模型性能评估指标，可以是多个</li>
<li>search_space：如果是普通的学习器则需要指定搜索空间</li>
<li>term_evals/term_time/terminator：终止条件，允许评估次数/允许调参时间多少秒/终止器对象</li>
<li>store_models：是否保存每次的模型</li>
<li>allow_hotstart：是否允许热启动预拟合模型</li>
<li>resolution：网格分辨率，网格搜索的配套参数</li>
<li>batch_size：批量大小，每批次放几组参数配置，以加快运算速度</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs {r}"># 将测试集索引设置为留出<br>task = mlr3::tsk("iris")<br>split = mlr3::partition(task, ratio = 0.8)<br>task$set_row_roles(split$test, "holdout")<br><br># 选择学习器，需要调参的用to_tune()设定搜索空间<br>learner = mlr3::lrn("classif.svm",<br>                    type = "C-classification",<br>                    kernel = "radial",<br>                    cost = to_tune(0.1, 10),<br>                    gamma = to_tune(0,5))<br><br># 5折交叉验证<br>instance = mlr3tuning::tune(method = "grid_search",<br>                            task = task,<br>                            learner = learner,<br>                            resampling = rsmp("cv", folds = 5),<br>                            measures = msr("classif.acc"),<br>                            resolution = 5)<br><br># 提取调参结果<br>instance$result<br><br># 调参档案<br>instance$archive<br><br># 调参结果可视化<br>mlr3viz::autoplot(instance, <br>                  type = "surface",<br>                  cols_x = c("cost", "gamma"))<br># 最优参数更新学习器参数，在训练集上训练模型，然后在测试集上做预测<br>learner$param_set$values = instance$result_learner_param_vals<br>learner$train(task) # 之所以这样直接写是因为前面写了holdout<br><br>prediction = learner$predict(task, row_ids = split$test)<br>prediction<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/000002.png" srcset="/img/loading.gif" lazyload alt="000002"></p>
<h3 id="自动调参器"><a href="#自动调参器" class="headerlink" title="自动调参器"></a>自动调参器</h3><h3 id="自动调参器-1"><a href="#自动调参器-1" class="headerlink" title="自动调参器"></a>自动调参器</h3><p>独立调参的缺点：</p>
<ul>
<li>最优参数需要手动更新</li>
<li>不方便实现嵌套重抽样</li>
</ul>
<p>自动调参将超参数和学习器封装到一起，实现自动调参过程，并可以像其他的学习器一样使用。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 创建任务并选择学习器</span><br>task <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"iris"</span><span class="hljs-punctuation">)</span><br>learner <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><br>  <span class="hljs-string">"classif.svm"</span><span class="hljs-punctuation">,</span><br>  type <span class="hljs-operator">=</span> <span class="hljs-string">"C-classification"</span><span class="hljs-punctuation">,</span><br>  kernel <span class="hljs-operator">=</span> <span class="hljs-string">"radial"</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># ps()生成自动搜索空间</span><br>search.space <span class="hljs-operator">=</span> mlr3verse<span class="hljs-operator">::</span>ps<span class="hljs-punctuation">(</span>cost <span class="hljs-operator">=</span> p_dbl<span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                             <span class="hljs-built_in">gamma</span> <span class="hljs-operator">=</span> p_int<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># auto_tuner创建自动调参器</span><br><span class="hljs-comment"># 不用提供任务</span><br><br>at <span class="hljs-operator">=</span> mlr3tuning<span class="hljs-operator">::</span>auto_tuner<span class="hljs-punctuation">(</span><br>  method <span class="hljs-operator">=</span> <span class="hljs-string">"grid_search"</span><span class="hljs-punctuation">,</span><br>  learner <span class="hljs-operator">=</span> learner<span class="hljs-punctuation">,</span><br>  search_space <span class="hljs-operator">=</span> search.space<span class="hljs-punctuation">,</span><br>  resampling <span class="hljs-operator">=</span> rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  measure <span class="hljs-operator">=</span> msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  resolution <span class="hljs-operator">=</span> <span class="hljs-number">5</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 在全部数据上自动调参，预测新数据</span><br>at<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><br><br>dat <span class="hljs-operator">=</span> task<span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>at<span class="hljs-operator">$</span>predict_newdata<span class="hljs-punctuation">(</span>dat<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 外层采样4折交叉验证重抽样并保存模型</span><br><span class="hljs-comment"># 执行嵌套重抽样，外层循环5次，内层的超参数调参循环5次</span><br>rr <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>resample<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> at<span class="hljs-punctuation">,</span> rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><br><span class="hljs-comment"># 查看模型的平均性能</span><br>rr<span class="hljs-operator">$</span>aggregate<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 默认classif.ce</span><br>rr<span class="hljs-operator">$</span>aggregate<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 将上述步骤改为嵌套调参</span><br>rr <span class="hljs-operator">=</span> mlr3tuning<span class="hljs-operator">::</span>tune_nested<span class="hljs-punctuation">(</span><br>  method <span class="hljs-operator">=</span> <span class="hljs-string">"grid_search"</span><span class="hljs-punctuation">,</span><br>  task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">,</span><br>  learner <span class="hljs-operator">=</span> learner<span class="hljs-punctuation">,</span><br>  search_space <span class="hljs-operator">=</span> search.space<span class="hljs-punctuation">,</span><br>  inner_resampling <span class="hljs-operator">=</span> rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span>  <span class="hljs-number">5</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  outer_resampling <span class="hljs-operator">=</span> rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  measure <span class="hljs-operator">=</span> msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  resolution <span class="hljs-operator">=</span> <span class="hljs-number">5</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看模型的平均性能</span><br>rr<span class="hljs-operator">$</span>aggregate<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 默认classif.ce</span><br>rr<span class="hljs-operator">$</span>aggregate<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <br><br><span class="hljs-comment"># 查看每次的</span><br>rr<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 部分参数间具有依赖关系，需要进行声明</span><br>search.space <span class="hljs-operator">=</span> mlr3verse<span class="hljs-operator">::</span>ps<span class="hljs-punctuation">(</span><br>  cost <span class="hljs-operator">=</span> p_dbl<span class="hljs-punctuation">(</span><span class="hljs-built_in">log</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-built_in">log</span><span class="hljs-punctuation">(</span><span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> trafo <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-built_in">exp</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  kernel <span class="hljs-operator">=</span> p_fct<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">"polynomial"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"radial"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  degree <span class="hljs-operator">=</span> p_int<span class="hljs-punctuation">(</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> depends <span class="hljs-operator">=</span> kernel <span class="hljs-operator">==</span> <span class="hljs-string">"polynomial"</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="正则化回归"><a href="#正则化回归" class="headerlink" title="正则化回归"></a>正则化回归</h2><h3 id="加载需要的包-1"><a href="#加载需要的包-1" class="headerlink" title="加载需要的包"></a>加载需要的包</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs {r}">library(tidyverse)<br>library(mlr3verse)<br>library(mlr3pipelines)<br>library(ggthemes)<br>library(ggplot2)<br></code></pre></td></tr></tbody></table></figure>
<h3 id="为什么使用正则化回归"><a href="#为什么使用正则化回归" class="headerlink" title="为什么使用正则化回归"></a>为什么使用正则化回归</h3><p>多元线性回归时，部分变量之间存在多重共线性，剔除某个变量后回归系数会变化很大，得到的回归模型是“伪回归”，这时候就需要岭回归、Lasso回归或者是弹性网回归，这些方法都是基于一种正则化技术，可以减少过拟合。</p>
<h3 id="岭回归"><a href="#岭回归" class="headerlink" title="岭回归"></a>岭回归</h3><p>岭回归是一种改良后的最小二乘法，通过放弃最小二乘法的无偏性，损失部分信息、降低部分精度为代价，得到更符合实际、更可靠的回归方法。</p>
<p><strong>需要注意的是岭回归中自变量的量纲对模型的影响非常大，因此需要对自变量进行标准化，保证所有自变量都是一个量纲上。</strong></p>
<p>岭回归的最佳系数是通过梯度下降法优化得到的。</p>
<h3 id="Lasso回归"><a href="#Lasso回归" class="headerlink" title="Lasso回归"></a>Lasso回归</h3><p>Lasso回归和岭回归的差异在于惩罚项不同。</p>
<h3 id="弹性网回归"><a href="#弹性网回归" class="headerlink" title="弹性网回归"></a>弹性网回归</h3><p>弹性网回归是岭回归和Lasso回归的整合。</p>
<h3 id="mlr3案例"><a href="#mlr3案例" class="headerlink" title="mlr3案例"></a>mlr3案例</h3><p>mlr3调用glmnet包实现正则化回归。有两个学习器：</p>
<ul>
<li>regr.glmnet：调用glmnet::glmnet()</li>
<li>regr.cv_glmnet：调用glmnet::cv.glmnet</li>
</ul>
<p>两个函数的基本用法为：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs {r}">glmnet::glmnet(x,y,family,alpha,lambda = NULL)<br>glmnet::cv.glmnet(x,y,family,alpha,lambda = NULL)<br></code></pre></td></tr></tbody></table></figure>
<p>其中：</p>
<ul>
<li>x：自变量</li>
<li>y：因变量</li>
<li>family：因变量的类型，默认是gaussian，还可以是binomial、poisson、multinomial、cox、mgaussian</li>
<li>alpha：弹性网混合系数，0为岭回归，1为Lasso回归，介于0和1之间的是弹性网回归</li>
<li>lambda：惩罚度的超参数</li>
</ul>
<p>二者的区别在于cv.glmnet已经的带有交叉验证对lambda调参，自动选择最优的lambda.</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 使用自带的任务</span><br>boston <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"boston_housing"</span><span class="hljs-punctuation">)</span><br><br>glimpse<span class="hljs-punctuation">(</span>boston<span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># glmnet不能直接处理因子型变量</span><br><span class="hljs-comment"># town水平过于分散，采用效应编码</span><br><span class="hljs-comment"># chas是两因子水平，处理成虚拟变量</span><br><br>prep <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"encode"</span><span class="hljs-punctuation">,</span> <br>                         method <span class="hljs-operator">=</span> <span class="hljs-string">"treatment"</span><span class="hljs-punctuation">,</span><br>                         affect_columns <span class="hljs-operator">=</span> selector_name<span class="hljs-punctuation">(</span><span class="hljs-string">"chas"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;&gt;%</span><br>  mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"encodeimpact"</span><span class="hljs-punctuation">,</span><br>                    affect_columns <span class="hljs-operator">=</span> selector_name<span class="hljs-punctuation">(</span><span class="hljs-string">"town"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br>boston <span class="hljs-operator">=</span> prep<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>boston<span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span> <span class="hljs-comment"># 这一步的训练相当于对数据进行处理</span><br><br><span class="hljs-comment"># 分层抽样划分训练集和测试集</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>split <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>partition<span class="hljs-punctuation">(</span>boston<span class="hljs-punctuation">,</span> ratio <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 选择学习器</span><br>learner <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.glmnet"</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><br>learner<br><br><span class="hljs-comment"># 查看学习器的所有超参数及其默认值</span><br>learner<span class="hljs-operator">$</span>param_set<br><br><span class="hljs-comment"># 对lambda进行自动调参</span><br><br><span class="hljs-comment"># 设置搜索空间</span><br>search.space <span class="hljs-operator">=</span> mlr3verse<span class="hljs-operator">::</span>ps<span class="hljs-punctuation">(</span>s <span class="hljs-operator">=</span> p_dbl<span class="hljs-punctuation">(</span>lower <span class="hljs-operator">=</span> <span class="hljs-number">0.001</span><span class="hljs-punctuation">,</span> upper <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 自动调参器设置</span><br>at <span class="hljs-operator">=</span> mlr3tuning<span class="hljs-operator">::</span>auto_tuner<span class="hljs-punctuation">(</span><br>  method <span class="hljs-operator">=</span> <span class="hljs-string">"random_search"</span><span class="hljs-punctuation">,</span><br>  learner <span class="hljs-operator">=</span> learner<span class="hljs-punctuation">,</span><br>  resampling <span class="hljs-operator">=</span> rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  measure <span class="hljs-operator">=</span> msr<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.rmse"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  search_space <span class="hljs-operator">=</span> search.space<span class="hljs-punctuation">,</span><br>  term_evals <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 计算十次后终止计算</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 启动自动调参过程</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>at<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>boston<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看最优参数</span><br>at<span class="hljs-operator">$</span>tuning_result<br><br><span class="hljs-comment"># 查看超参数变化对模型性能的影响</span><br><br>at<span class="hljs-operator">$</span>archive <span class="hljs-operator">%&gt;%</span> <br>  as.data.table<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  ggplot<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>s<span class="hljs-punctuation">,</span> regr.rmse<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_line<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">"steelblue"</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span>color <span class="hljs-operator">=</span> <span class="hljs-string">"red"</span><span class="hljs-punctuation">,</span> size <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  scale_x_continuous<span class="hljs-punctuation">(</span>breaks <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  pac4xiang<span class="hljs-operator">::</span>mytheme<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 最优参数训练模型</span><br>learner<span class="hljs-operator">$</span>param_set<span class="hljs-operator">$</span>values <span class="hljs-operator">=</span> at<span class="hljs-operator">$</span>tuning_result<span class="hljs-operator">$</span>learner_param_vals<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br><br><span class="hljs-comment"># 或者用最优参数重新构建学习器</span><br>learner <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.glmnet"</span><span class="hljs-punctuation">,</span> alpha <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> s <span class="hljs-operator">=</span> at<span class="hljs-operator">$</span>tuning_result<span class="hljs-operator">$</span>s<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 在训练集上训练模型</span><br>learner<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>boston<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘图</span><br>mlr3viz<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>learner<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> pac4xiang<span class="hljs-operator">::</span>mytheme<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 提取岭回归系数</span><br><br>model <span class="hljs-operator">=</span> learner<span class="hljs-operator">$</span>model<br>coef<span class="hljs-punctuation">(</span>model<span class="hljs-punctuation">,</span> s <span class="hljs-operator">=</span> at<span class="hljs-operator">$</span>tuning_result<span class="hljs-operator">$</span>s<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 模型绘图</span><br><span class="hljs-comment"># 可以看出随着lambda增大，越来越多的指标系数逼近于0</span><br>plot<span class="hljs-punctuation">(</span>model<span class="hljs-punctuation">,</span> xvar <span class="hljs-operator">=</span> <span class="hljs-string">"lambda"</span><span class="hljs-punctuation">,</span> label <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 模型预测</span><br>predict <span class="hljs-operator">=</span> learner<span class="hljs-operator">$</span>predict<span class="hljs-punctuation">(</span>boston<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>test<span class="hljs-punctuation">)</span><br><br>predict<br><br><span class="hljs-comment"># 模型评估</span><br>predict<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.rmse"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># 均方根误差</span><br>predict<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"regr.rsq"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-comment"># R2</span><br><br><span class="hljs-comment"># 预测新数据</span><br>new.data <span class="hljs-operator">=</span> boston<span class="hljs-operator">$</span>data<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><br>learner<span class="hljs-operator">$</span>predict_newdata<span class="hljs-punctuation">(</span>new.data<span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<p>其余两种正则化回归的调参过程类似。</p>
<p>弹性网回归时，超参数调参需要加一个参数：</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs R">search.space <span class="hljs-operator">=</span> mlr3verse<span class="hljs-operator">::</span>ps<span class="hljs-punctuation">(</span>s <span class="hljs-operator">=</span> p_dbl<span class="hljs-punctuation">(</span>lower <span class="hljs-operator">=</span> <span class="hljs-number">0.001</span><span class="hljs-punctuation">,</span> upper <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                             alpha <span class="hljs-operator">=</span> p_dbl<span class="hljs-punctuation">(</span>lower <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> upper <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="Logistic回归"><a href="#Logistic回归" class="headerlink" title="Logistic回归"></a>Logistic回归</h2><h3 id="加载需要的包-2"><a href="#加载需要的包-2" class="headerlink" title="加载需要的包"></a>加载需要的包</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs {r}">library(tidyverse)<br>library(mlr3verse)<br>library(mlr3pipelines)<br>library(ggthemes)<br>library(ggplot2)<br></code></pre></td></tr></tbody></table></figure>
<h3 id="广义线性模型"><a href="#广义线性模型" class="headerlink" title="广义线性模型"></a>广义线性模型</h3><p>线性回归要求因变量服从正态分布，但是实际情况下因变量可能是类别型、计数型等，因此需要将线性回归推广到广义线性模型。</p>
<p>广义线性模型相当于一个复合函数，先做线性回归，再接一个变换，变换后得到的就是非正态的因变量数据。</p>
<p><img src="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/image-20230211195950010.png" srcset="/img/loading.gif" lazyload alt="image-20230211195950010" style="zoom:50%;"></p>
<p>这个过程应该是反过来理解，完成这个变换的函数叫做链接函数。</p>
<p><img src="https://xiang-1257290193.cos.ap-guangzhou.myqcloud.com/Typora/image-20230211200548869.png" srcset="/img/loading.gif" lazyload alt="image-20230211200548869" style="zoom:50%;"></p>
<h3 id="mlr3案例-1"><a href="#mlr3案例-1" class="headerlink" title="mlr3案例"></a>mlr3案例</h3><figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 创建损失矩阵</span><br>costs <span class="hljs-operator">=</span> matrix<span class="hljs-punctuation">(</span><span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-operator">-</span><span class="hljs-number">0.35</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> nrow <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span><br><span class="hljs-built_in">dimnames</span><span class="hljs-punctuation">(</span>costs<span class="hljs-punctuation">)</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>response <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">"good"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"bad"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                       truth <span class="hljs-operator">=</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-string">"good"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"bad"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>costs<br><br><span class="hljs-comment"># 选择自带任务</span><br>task <span class="hljs-operator">=</span>  mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"german_credit"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 选择学习器</span><br>learner <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.log_reg"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看学习器参数</span><br><span class="hljs-comment"># 该处没有参数需要超参数调参</span><br>learner<span class="hljs-operator">$</span>param_set<span class="hljs-operator">$</span>ids<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 划分数据</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>split <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>partition<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> ratio <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 训练模型</span><br>learner<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 提取回归系数</span><br>coef<span class="hljs-punctuation">(</span>learner<span class="hljs-operator">$</span>model<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 预测</span><br>prediction <span class="hljs-operator">=</span> learner<span class="hljs-operator">$</span>predict<span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>test<span class="hljs-punctuation">)</span><br>prediction<br><br><span class="hljs-comment"># 提取混淆矩阵</span><br>prediction<span class="hljs-operator">$</span>confusion<br><br><span class="hljs-comment"># 查看准确率</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 召回率</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.recall"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 计算银行的代价</span><br><span class="hljs-comment"># 负值表示银行会赚钱</span><br><span class="hljs-built_in">sum</span><span class="hljs-punctuation">(</span>prediction<span class="hljs-operator">$</span>confusion <span class="hljs-operator">*</span> costs<span class="hljs-punctuation">)</span><span class="hljs-operator">/</span><span class="hljs-built_in">length</span><span class="hljs-punctuation">(</span>split<span class="hljs-operator">$</span>test<span class="hljs-punctuation">)</span> <span class="hljs-operator">-&gt;</span> ave.cost<br>ave.cost<br><span class="hljs-comment"># 假设每人贷款20000，贷给10000个人，银行的收益为：</span><br>ave.cost <span class="hljs-operator">*</span> <span class="hljs-number">20000</span> <span class="hljs-operator">*</span> <span class="hljs-number">10000</span> <span class="hljs-operator">*</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span> <span class="hljs-comment"># -1将收益表示为银行赚的钱</span><br><br><span class="hljs-comment"># 上述方式是使用0.5作为阈值，但是不一定是最佳值</span><br><span class="hljs-comment"># 使用“代价-敏感”方式对模型进行评估</span><br>cost.msr <span class="hljs-operator">=</span> msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.costs"</span><span class="hljs-punctuation">,</span> costs <span class="hljs-operator">=</span> costs<span class="hljs-punctuation">)</span><br>prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>cost.msr<span class="hljs-punctuation">,</span> task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 将学习器的预测方式变为概率</span><br>learner<span class="hljs-operator">$</span>predict_type <span class="hljs-operator">=</span> <span class="hljs-string">"prob"</span><br>learner<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br>prediction <span class="hljs-operator">=</span> learner<span class="hljs-operator">$</span>predict<span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>test<span class="hljs-punctuation">)</span><br><br>prediction<br><br><span class="hljs-comment"># 绘图</span><br>mlr3viz<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>prediction<span class="hljs-punctuation">,</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"roc"</span><span class="hljs-punctuation">)</span><br><br>mlr3viz<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>prediction<span class="hljs-punctuation">,</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"prc"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制二分类校准曲线</span><br>prediction <span class="hljs-operator">%&gt;%</span> <br>  as.data.table<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>mutate<span class="hljs-punctuation">(</span>bins <span class="hljs-operator">=</span> cut<span class="hljs-punctuation">(</span>prob.good<span class="hljs-punctuation">,</span> breaks <span class="hljs-operator">=</span> seq<span class="hljs-punctuation">(</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>group_by<span class="hljs-punctuation">(</span>bins<span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  dplyr<span class="hljs-operator">::</span>summarise<span class="hljs-punctuation">(</span>p.pred <span class="hljs-operator">=</span> mean<span class="hljs-punctuation">(</span>prob.good<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>                   p.true <span class="hljs-operator">=</span> mean<span class="hljs-punctuation">(</span>truth <span class="hljs-operator">==</span> <span class="hljs-string">"good"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">%&gt;%</span> <br>  ggplot<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>p.pred<span class="hljs-punctuation">,</span> p.true<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">5</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">"white"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_point<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">"white"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_segment<span class="hljs-punctuation">(</span>aes<span class="hljs-punctuation">(</span>x <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> xend <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> y <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> yend <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> linetype <span class="hljs-operator">=</span> <span class="hljs-string">"dashed"</span><span class="hljs-punctuation">,</span> color <span class="hljs-operator">=</span> <span class="hljs-string">"red"</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  geom_line<span class="hljs-punctuation">(</span>size <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span><br>  pac4xiang<span class="hljs-operator">::</span>mytheme<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br>  <br><span class="hljs-comment"># 手动调节阈值参数</span><br><span class="hljs-comment"># 自定义函数</span><br>with.threshod <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>th<span class="hljs-punctuation">)</span><span class="hljs-punctuation">{</span><br>  prediction<span class="hljs-operator">$</span>set_threshold<span class="hljs-punctuation">(</span>th<span class="hljs-punctuation">)</span><br>  prediction<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>measures <span class="hljs-operator">=</span> cost.msr<span class="hljs-punctuation">,</span> task <span class="hljs-operator">=</span> task<span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">}</span><br><br><span class="hljs-comment"># 测试</span><br>with.threshod<span class="hljs-punctuation">(</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">)</span><br>with.threshod<span class="hljs-punctuation">(</span><span class="hljs-number">0.75</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 将不同阈值的代价函数传递给optimize()函数，在[0.5,1]之间找到最小值</span><br>best <span class="hljs-operator">=</span> optimize<span class="hljs-punctuation">(</span>with.threshod<span class="hljs-punctuation">,</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">(</span><span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br>best<br></code></pre></td></tr></tbody></table></figure>
<h2 id="KNN"><a href="#KNN" class="headerlink" title="KNN"></a>KNN</h2><h3 id="加载需要的包-3"><a href="#加载需要的包-3" class="headerlink" title="加载需要的包"></a>加载需要的包</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs {r}">library(tidyverse)<br>library(mlr3verse)<br>library(mlr3pipelines)<br>library(ggthemes)<br>library(ggplot2)<br></code></pre></td></tr></tbody></table></figure>
<h3 id="如何理解KNN"><a href="#如何理解KNN" class="headerlink" title="如何理解KNN"></a>如何理解KNN</h3><p>简单理解为<strong>近朱者赤近墨者黑</strong>。</p>
<p>KNN和聚类分析的区别在于KNN是有因变量的，聚类分析没有因变量，属于无监督学习。</p>
<p>KNN最重要的参数是K. 距离方法也可以进行超参数调参选择最优的距离计算方法。</p>
<p>常用的距离算法有：</p>
<ul>
<li>欧氏距离：两点之间直线距离的推广，相当于直角三角形的斜边长度。</li>
<li>曼哈顿距离：相当于两个直角边的和。</li>
<li>余弦相似度：两个向量的余弦夹角。</li>
<li>杰卡德相似系数：两个集合交集与并集的元素个数之比。</li>
</ul>
<p>后面两种方法常用于文本挖掘和推荐算法。</p>
<p><strong>philentropy</strong>这个包可以实现46种距离的计算。</p>
<h3 id="如何确定最佳K值"><a href="#如何确定最佳K值" class="headerlink" title="如何确定最佳K值"></a>如何确定最佳K值</h3><ul>
<li>交叉验证法：不同的K值进行m折交叉验证。</li>
<li>近邻样本加权：如果已知样本距离未知样本距离较远，则需要进行加权处理。</li>
</ul>
<h3 id="mlr3实例"><a href="#mlr3实例" class="headerlink" title="mlr3实例"></a>mlr3实例</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs {r}"># 读取数据<br>dat = readxl::read_excel("../data/Knowledge.xlsx") %&gt;% <br>  dplyr::mutate(UNS = as.factor(UNS))<br><br>table(dat$UNS)<br><br># 创建任务<br>task = mlr3::as_task_classif(dat, target = "UNS")<br>task<br><br># 绘图<br>mlr3viz::autoplot(task,  type = "pairs")<br><br># 划分数据<br>set.seed(123)<br>split = mlr3::partition(task, ratio = 0.7)<br><br># 选择学习器<br>learner = mlr3::lrn("classif.kknn",<br>                    predict_type = "prob",<br>                    kernel = "rectangular",<br>                    scale = FALSE)<br><br>learner<br># 查看学习器超参数<br>learner$param_set<br><br># 正对K和距离进行调参<br>search.space = mlr3verse::ps(<br>  k = p_int(lower = 2, upper = 15),<br>  distance = p_int(lower = 1, upper = 2) # 1是欧式距离，2是曼哈顿距离<br>)<br><br>at = mlr3verse::auto_tuner(<br>  method = "grid_search", # 随机搜索<br>  learner = learner,<br>  resampling = rsmp("cv", folds = 10),<br>  measure = msr("classif.acc"),<br>  search_space = search.space,<br>  term_evals = 10<br>)<br><br># 开始训练<br>at$train(task, row_ids = split$train)<br><br># 查看最优参数<br>at$tuning_result<br><br># 自动绘图<br>mlr3viz::autoplot(at$tuning_instance, type = "performance") +<br>  pac4xiang::mytheme()<br><br>mlr3viz::autoplot(at$tuning_instance, type = "points") +<br>  pac4xiang::mytheme()<br><br># 手动展示调参结果<br>at$archive %&gt;% <br>  as.data.table() %&gt;% <br>  dplyr::select(k, distance, classif.acc) %&gt;% <br>  dplyr::arrange(-classif.acc) %&gt;% <br>  dplyr::slice(1:5)<br><br># 对k进行不均匀调参，加入对数-指数变换，同时再对kernel进行调参<br>search.space = mlr3verse::ps(<br>  # 必须保证k是整数<br>  k = p_dbl(lower = log(3), upper = log(30), trafo = function(x)round(exp(x))),<br>  distance = p_int(lower = 1, upper = 2), # 1是欧式距离，2是曼哈顿距离<br>  kernel = p_fct(c("rectangular", "triangular", "epanechnikov", <br>                    "biweight", "triweight", "cos", "inv", "gaussian",<br>                    "rank", "optimal")) # 全选所有的kernel<br>)<br><br>at = mlr3verse::auto_tuner(<br>  method = "grid_search", # 随机搜索<br>  learner = learner,<br>  resampling = rsmp("cv", folds = 10),<br>  measure = msr("classif.acc"),<br>  search_space = search.space,<br>  term_evals = 20<br>)<br><br># 开始训练<br>at$train(task, row_ids = split$train)<br><br># 查看最优参数<br>at$tuning_result<br><br># 手动展示调参结果<br># 注意该处的K值<br>at$archive %&gt;% <br>  as.data.table() %&gt;% <br>  dplyr::select(k = x_domain_k, distance, kernel, classif.acc) %&gt;% <br>  dplyr::arrange(-classif.acc) %&gt;% <br>  dplyr::slice(1:10)<br><br># 选择最优参数更新学习器参数然后进行训练<br>learner$param_set$values = at$tuning_result$learner_param_vals[[1]]<br>learner$train(task, row_ids = split$train)<br><br># 进行预测<br>learner$predict(task, row_ids = split$test) -&gt; predi<br><br># 提取混淆矩阵<br>predi$confusion<br><br># 查看准确率<br>predi$score(msr("classif.acc"))<br></code></pre></td></tr></tbody></table></figure>
<p>回归的过程类似。</p>
<h2 id="随机森林"><a href="#随机森林" class="headerlink" title="随机森林"></a>随机森林</h2><h3 id="加载需要的包-4"><a href="#加载需要的包-4" class="headerlink" title="加载需要的包"></a>加载需要的包</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs {r}">library(tidyverse)<br>library(mlr3verse)<br>library(mlr3pipelines)<br>library(ggthemes)<br>library(ggplot2)<br></code></pre></td></tr></tbody></table></figure>
<h3 id="关于集成学习"><a href="#关于集成学习" class="headerlink" title="关于集成学习"></a>关于集成学习</h3><p>集成学习就是通过构建多个基学习器，按一定的策略结合成强学习器完成学习任务。</p>
<h3 id="装袋法"><a href="#装袋法" class="headerlink" title="装袋法"></a>装袋法</h3><p>装袋法采用的是并行机制，基学习器之间没有先后顺序，可以同时进行。装袋法采用的是有放回的抽样方法。</p>
<p>装袋法的代表算法是随机森林。</p>
<h3 id="提升法"><a href="#提升法" class="headerlink" title="提升法"></a>提升法</h3><p>提升法采用的是串行机制，基学习器之间存在依赖关系，按顺序进行训练。该算法主要关注降低偏差，每次迭代都关注训练过程中错误的样本，将弱学习器提升为强学习器。</p>
<p>代表算法有AdaBoost、GBDT、XGboost、LightGBM和catBoost等。</p>
<h3 id="堆叠法"><a href="#堆叠法" class="headerlink" title="堆叠法"></a>堆叠法</h3><p>堆叠法采用的是分阶段机制，将若干基模型的输出作为输入，再接一层主学习器，得到最终的预测。</p>
<h3 id="随机森林原理"><a href="#随机森林原理" class="headerlink" title="随机森林原理"></a>随机森林原理</h3><p>决策树是很弱的分类器，效果一般，但是将多个若学习器通过集成学习技术组合到一起，就可以实现强分类器。</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>不容易过拟合，无需建制</li>
<li>可以并行计算，单个决策树可以同时训练</li>
<li>可以做分类或者是回归，无需调参，就可以获得很高的分类精度</li>
<li>对缺失值和异常值不敏感</li>
<li>可以处理很多变量，无需对变量进行约减</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>树越多越稳定越准确，但是也越慢</li>
<li>更擅长分类，回归差一些，回归预测的范围只能在训练数据的范围内</li>
<li>结果不容易解释，属于“黑箱”模型</li>
</ul>
<h3 id="mlr3案例-2"><a href="#mlr3案例-2" class="headerlink" title="mlr3案例"></a>mlr3案例</h3><p>mlr3实现随机森林调用的是ranger包（<strong>要求数据不能有NA</strong>）。</p>
<figure class="highlight r"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs R"><span class="hljs-comment"># 使用自带的数据集创建任务</span><br>task <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>tsk<span class="hljs-punctuation">(</span><span class="hljs-string">"pima"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看数据缺失情况</span><br>task<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 直方图插补法进行缺失值插补</span><br>po <span class="hljs-operator">=</span> mlr3pipelines<span class="hljs-operator">::</span>po<span class="hljs-punctuation">(</span><span class="hljs-string">"imputehist"</span><span class="hljs-punctuation">)</span><br><br>task.new <span class="hljs-operator">=</span> po<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span><span class="hljs-built_in">list</span><span class="hljs-punctuation">(</span>task<span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br><br>task.new<span class="hljs-operator">$</span>missings<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 划分数据</span><br>set.seed<span class="hljs-punctuation">(</span><span class="hljs-number">123</span><span class="hljs-punctuation">)</span><br>split <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>partition<span class="hljs-punctuation">(</span>task <span class="hljs-operator">=</span> task.new<span class="hljs-punctuation">,</span> ratio <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 选择学习器</span><br>learner <span class="hljs-operator">=</span> mlr3<span class="hljs-operator">::</span>lrn<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.ranger"</span><span class="hljs-punctuation">,</span><br>                    importance <span class="hljs-operator">=</span> <span class="hljs-string">"impurity"</span><span class="hljs-punctuation">,</span><br>                    predict_type <span class="hljs-operator">=</span> <span class="hljs-string">"prob"</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 查看学习器超参数</span><br>learner<span class="hljs-operator">$</span>param_set<br><br><span class="hljs-comment"># 超参数调参</span><br><span class="hljs-comment"># 对树的数量和最小节点数进行调参</span><br>search.space <span class="hljs-operator">=</span> mlr3verse<span class="hljs-operator">::</span>ps<span class="hljs-punctuation">(</span><br>  num.trees <span class="hljs-operator">=</span> p_int<span class="hljs-punctuation">(</span>lower <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> upper <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span> trafo <span class="hljs-operator">=</span> <span class="hljs-keyword">function</span><span class="hljs-punctuation">(</span>x<span class="hljs-punctuation">)</span> <span class="hljs-number">20</span><span class="hljs-operator">*</span>x<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span> <span class="hljs-comment"># 步长为20</span><br>  min.node.size <span class="hljs-operator">=</span> p_int<span class="hljs-punctuation">(</span>lower <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> upper <span class="hljs-operator">=</span> <span class="hljs-number">30</span><span class="hljs-punctuation">)</span><br><span class="hljs-punctuation">)</span><br><br>at <span class="hljs-operator">=</span> mlr3tuning<span class="hljs-operator">::</span>auto_tuner<span class="hljs-punctuation">(</span><br>  method <span class="hljs-operator">=</span> <span class="hljs-string">"random_search"</span><span class="hljs-punctuation">,</span><br>  learner <span class="hljs-operator">=</span> learner<span class="hljs-punctuation">,</span><br>  resampling <span class="hljs-operator">=</span> rsmp<span class="hljs-punctuation">(</span><span class="hljs-string">"cv"</span><span class="hljs-punctuation">,</span> folds <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  measure <span class="hljs-operator">=</span> msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span><br>  search_space <span class="hljs-operator">=</span> search.space<span class="hljs-punctuation">,</span><br>  term_evals <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>  store_models <span class="hljs-operator">=</span> <span class="hljs-literal">TRUE</span><br><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 选练模型</span><br>at<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task.new<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 提取最佳参数</span><br>at<span class="hljs-operator">$</span>tuning_result<br><br><span class="hljs-comment"># 最佳参数放回到学习器</span><br>learner<span class="hljs-operator">$</span>param_set<span class="hljs-operator">$</span>values <span class="hljs-operator">=</span> at<span class="hljs-operator">$</span>tuning_result<span class="hljs-operator">$</span>learner_param_vals<span class="hljs-punctuation">[[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><br><br><span class="hljs-comment"># 更新后的学习器进行训练</span><br>learner<span class="hljs-operator">$</span>train<span class="hljs-punctuation">(</span>task.new<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>train<span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 进行预测</span><br>learner<span class="hljs-operator">$</span>predict<span class="hljs-punctuation">(</span>task.new<span class="hljs-punctuation">,</span> row_ids <span class="hljs-operator">=</span> split<span class="hljs-operator">$</span>test<span class="hljs-punctuation">)</span> <span class="hljs-operator">-&gt;</span> predict.res<br><br><span class="hljs-comment"># 提取混淆矩阵</span><br>predict.res<span class="hljs-operator">$</span>confusion<br><br><span class="hljs-comment"># 查看准确率</span><br>predict.res<span class="hljs-operator">$</span>score<span class="hljs-punctuation">(</span>msr<span class="hljs-punctuation">(</span><span class="hljs-string">"classif.acc"</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-comment"># 绘制ROC曲线</span><br>mlr3viz<span class="hljs-operator">::</span>autoplot<span class="hljs-punctuation">(</span>predict.res<span class="hljs-punctuation">,</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"roc"</span><span class="hljs-punctuation">)</span><br></code></pre></td></tr></tbody></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E5%AD%A6/" class="category-chain-item">生物信息学</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E5%AD%A6/" class="print-no-link">#生物信息学</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>R语言机器学习框架mlr3学习笔记</div>
      <div>https://lixiang117423.github.io/article/learningmlr3/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>小蓝哥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年2月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/article/neighborfungi/" title="植物邻居可以促使或者是阻断根部真菌的病害传播">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">植物邻居可以促使或者是阻断根部真菌的病害传播</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/article/rice-rice/" title="水稻-水稻互作中第一个主要的locus">
                        <span class="hidden-mobile">水稻-水稻互作中第一个主要的locus</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      滇ICP备2021000708号-4
    </a>
  </span>
  
</div>

  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
